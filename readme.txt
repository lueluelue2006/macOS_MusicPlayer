# 安装与运行（DMG）— 快速开始（v2.4）

1) 下载发布页面中的 DMG 安装包（文件名示例：MusicPlayer-v2.4.dmg）
2) 双击打开 DMG，将“MusicPlayer.app”**拖入**“应用程序”或任意文件夹
3) 首次运行故障排除（无法验证开发者或者显示“文件已损坏”）
   - 方法一（推荐）：打开“系统设置 → 隐私与安全性”，在底部“安全性”区域找到被阻止的“MusicPlayer”，点击“仍要打开”。随后再次从“应用程序”启动。
   - 方法二（终端）：在“终端”执行以下命令移除隔离属性（比 -cr 更安全精确）：
     ```
     xattr -dr com.apple.quarantine /Applications/MusicPlayer.app
     ```
     说明：
     - 通常无需 sudo；若“应用程序”目录权限被修改导致无权限，可在命令前加 sudo：
       ```
       sudo xattr -dr com.apple.quarantine /Applications/MusicPlayer.app
       ```
     - 若 app 不在 /Applications，请替换为实际 .app 路径。
4) 之后可从“应用程序”或 Launchpad 启动

卸载方法：将“MusicPlayer.app”移至废纸篓（可选删除位于用户默认的播放列表与缓存）

————————————————————————————————————————————————————————

# MusicPlayer for macOS — 项目介绍

一款基于 SwiftUI 与 AVFoundation 打造的简洁音乐播放器。支持拖拽添加歌曲/文件夹、播放列表管理、随机/循环、断点续播、音量均衡（自动分析不同音源的响度）、动态歌词显示（内嵌/外置 .lrc），并提供基础的音频元数据（标题/艺术家/专辑）编辑能力（原生支持 M4A/MP4/AAC；其他格式给出 FFmpeg 命令引导）。

## 目录
- 项目亮点
- 快速上手（面向普通用户）
- 功能详解
- 常见问题与限制
- FFmpeg 元数据编辑指引
- 隐私与权限
- 项目结构（面向开发者）
- 作者

## 项目亮点

- 易用的拖拽体验：把音乐文件或文件夹拖到窗口即可添加，支持“扫描子文件夹”开关
- 播放体验细节：
  - 随机/循环（二者互斥，防止冲突）
  - 记忆播放进度与上次播放歌曲，应用重启后自动恢复
  - 轻量级音量均衡：按文件分析响度，持久化缓存，避免切歌音量差异
- 歌词体验：
  - 自动识别内嵌歌词（支持静态与部分动态/时间轴）
  - 支持同名 .lrc 外置歌词（自动尝试 UTF-8/UTF-16/UTF-32/GB18030）
  - 同步歌词自动跟随、定位当前句、用户滚动后延迟恢复跟随；双击句子可跳转进度
- 性能说明：
  - 加载“无歌词”的歌曲表现良好；实测加载约 200 首歌时，预计内存占用小于 150 MB
  - 加载“含歌词”的歌曲性能与内存占用尚未系统化测试，结果可能随歌词数量与长度波动
- 元数据编辑：
  - 原生写入 M4A/MP4/AAC 元数据
  - 其他格式（MP3/FLAC/OGG/WMA/APE/OPUS）给出可复制的 FFmpeg 命令说明
- 纯本地、无网络依赖；界面自适应窄/宽布局

—

## 快速上手（面向普通用户）

1) 添加音乐
   - 点击“选择音乐文件或文件夹”，或直接把文件/文件夹拖入窗口
   - 需要递归扫描子目录时，打开“扫描子文件夹”开关

2) 播放与控制
   - 在列表中单击一首歌即可播放
   - 使用播放控制区进行播放/暂停、上一首/下一首、进度拖动
   - “随机”和“循环”互斥：同时开启会自动关闭另一个

3) 歌词
   - 若识别到歌词，可在播放器面板中打开“显示歌词”
   - 同步歌词支持自动跟随与“定位当前句”，双击某行可跳转到该时间

4) 元数据编辑
   - 在播放列表条目中点击“铅笔”图标
   - 蓝色图标：可直接编辑（M4A/MP4/AAC）
   - 橙色图标：提供 FFmpeg 命令指引（复制到终端执行）
   - 灰色图标：当前格式不支持编辑

5) 进度与列表恢复
   - 应用会自动保存当前播放的歌曲与进度以及播放列表；再次打开后自动恢复

—

## 功能详解

- 播放与播放列表
  - 拖拽添加、批量添加文件夹（可选递归）
  - 关键词搜索（标题/艺术家/专辑/文件名）
  - 清空、删除单曲、刷新全部元数据
  - 随机播放采用队列式洗牌，记录当前位置，前后切歌行为可预期

- 歌词系统
  - 内嵌歌词：从音频元数据中扫描（ID3/QuickTime/iTunes 相关域）
  - 外置 .lrc：同名文件自动解析；多种编码猜测
  - 同步歌词：自动跟随播放时间，支持暂停自动跟随和手动定位
  - UI 交互：双击歌词行可跳转；显示歌词来源标签（内嵌/外置/手动）

- 音量均衡
  - 基于 RMS 的轻量分析，计算每首歌的增益系数
  - 结果缓存并持久化，避免重复分析
  - 可随时开关音量均衡

- 元数据编辑
  - M4A/MP4/AAC：使用 AVAssetExportSession 直接写回
  - 其他格式：生成对应的 FFmpeg 命令（保持原码流拷贝或给出转换建议）

—

## 常见问题与限制

- 为什么 MP3 不能直接写元数据？
  - macOS 原生 API 不支持直接写入 MP3 元数据，需第三方库；当前版本提供 FFmpeg 命令引导
- 为什么歌词有时识别不到？
  - 不同封装器对歌词存储不一致；可放置同名 .lrc 文件作为兜底
- 音量均衡与专业标准（ReplayGain/R128）
  - 当前为轻量方案，非严格标准；后续计划提供更专业的分析

—

## 安装与运行（DMG）

1) 下载发布页面中的 DMG 安装包（文件名示例：MusicPlayer-v2.4.dmg）
2) 双击打开 DMG，将“MusicPlayer.app”拖入“应用程序”或任意文件夹
3) 首次运行故障排除（无法验证开发者或者显示“文件已损坏”）
   - 方法一（推荐）：打开“系统设置 → 隐私与安全性”，在底部“安全性”区域找到被阻止的“MusicPlayer”，点击“仍要打开”。随后再次从“应用程序”启动。
   - 方法二（终端）：在“终端”执行以下命令移除隔离属性（比 -cr 更安全精确）：
     ```
     xattr -dr com.apple.quarantine /Applications/MusicPlayer.app
     ```
     说明：
     - 通常无需 sudo；若“应用程序”目录权限被修改导致无权限，可在命令前加 sudo：
       ```
       sudo xattr -dr com.apple.quarantine /Applications/MusicPlayer.app
       ```
     - 若 app 不在 /Applications，请替换为实际 .app 路径。
4) 之后可从“应用程序”或 Launchpad 启动

卸载方法：将“MusicPlayer.app”移至废纸篓（可选删除位于用户默认的播放列表与缓存）
——

## FFmpeg 元数据编辑指引（针对非苹果格式）

- 在播放列表中点击橙色“铅笔”按钮，会显示适合该格式的命令示例（如 MP3/FLAC/OGG/WMA/APE/OPUS）
- 使用方法（示例）：
  1) 通过 Homebrew 安装 FFmpeg：brew install ffmpeg
  2) 复制命令到“终端”执行，生成带新元数据的文件（一般会带 .edited 后缀或转换格式）
  3) 检查新文件正确后，可替换原文件或直接使用新文件

- WAV/AIFF 等不支持元数据或支持有限的格式，会给出转换为 M4A 的建议命令

—

## 隐私与权限

- 应用仅访问你通过“打开面板”或“拖拽”提供的本地文件路径
- 应用不访问网络、无远程上传；不包含统计/追踪代码

—


## 项目结构（面向开发者）

- 入口与框架
  - [`SwiftUI.ContentView()`](Sources/MusicPlayer/Views/ContentView.swift:1)：应用主界面，负责加载/恢复播放列表、刷新元数据、处理拖拽、监听恢复通知
  - [`Swift.MusicPlayerApp`](Sources/MusicPlayer/MusicPlayerApp.swift:6)：App 入口，DEBUG 下运行格式测试

- 模型与服务
  - 模型：[`Swift.AudioFile`](Sources/MusicPlayer/Models/AudioFile.swift:124)、[`Swift.AudioMetadata`](Sources/MusicPlayer/Models/AudioFile.swift:4)
  - 歌词：[`Swift.LyricsService`](Sources/MusicPlayer/Models/Lyrics.swift:56)、[`Swift.LyricsTimeline`](Sources/MusicPlayer/Models/Lyrics.swift:24)
  - 播放：[`Swift.AudioPlayer`](Sources/MusicPlayer/Services/AudioPlayer.swift:5)（AVAudioPlayer，计时器、进度保存、音量均衡、歌词加载）
  - 列表：[`Swift.PlaylistManager`](Sources/MusicPlayer/Services/PlaylistManager.swift:4)（扫描/搜索/洗牌/持久化/刷新元数据）
  - 元数据：[`Swift.MetadataEditor`](Sources/MusicPlayer/Services/MetadataEditor.swift:31)（原生写 Apple 格式 + 生成 FFmpeg 命令）

- 界面
  - 播放器面板：[`Swift.PlayerView`](Sources/MusicPlayer/Views/PlayerView.swift:1)（文件选择、当前歌曲信息、歌词容器、播放/音量控制）
  - 播放列表：[`Swift.PlaylistView`](Sources/MusicPlayer/Views/PlaylistView.swift:19)（搜索、子目录开关、条目操作、元数据编辑窗口）

- 打包发布
- 构建应用：`./build.sh`（生成 `MusicPlayer.app`，Info.plist 版本号 v2.4）
- 创建 DMG：`./create_dmg.sh`（输出文件：`MusicPlayer-v2.4.dmg`）
  - DMG 内容：`MusicPlayer.app`、`Applications` 快捷方式、`README.txt`

- CLI（调试/自动化）
  - 构建：`swift build -c release`
  - 位置：`.build/release/musicplayerctl`
  - 用法示例：
    - `musicplayerctl ping`
    - `musicplayerctl status --json`
    - `musicplayerctl toggle|pause|resume|next|prev|random|shuffle|loop`
    - `musicplayerctl play 乡间小路 蔡琴`
    - `musicplayerctl play --index 185`
    - `musicplayerctl seek 2:50`
    - `musicplayerctl volume 80%`
    - `musicplayerctl rate 1.25`
    - `musicplayerctl normalization off`
    - `musicplayerctl add <path> [path...]`
    - `musicplayerctl remove --index 185`
    - `musicplayerctl remove 乡间小路 蔡琴`
    - `musicplayerctl remove --all 未知艺术家`
    - `musicplayerctl screenshot --out /tmp/musicplayer.png`
  - 说明：
    - CLI 通过 `DistributedNotificationCenter` 与正在运行的 `MusicPlayer.app` 通信（因此需要先启动 App）。
    - `screenshot` 由 App 自己渲染窗口并导出 PNG（通常不需要“屏幕录制”权限）；若目标路径已存在会自动追加 `-1/-2` 避免覆盖。
    - `rate`（倍速）仅对当前运行生效，重启后恢复 `1.0×`。
    - `remove` 只会从播放列表移除条目，不会删除磁盘上的音频文件。

—

## 更新日志

2.4 - 2026-01-03
- 音量均衡：修复关闭均衡后仍可能被后台分析回写音量；限制应用增益后的最终音量不超过 100%。
- 音量均衡：空闲自动分析改为“无操作触发”，播放时也可后台预分析；用户操作会自动暂停自动预分析。
- 播放列表：已完成音量均衡分析的歌曲，在标题后显示“已分析”标记。
- 播放：检测“伪装成音频的 HTML/文本文件”（例如下载页保存为 .mp3），并给出明确提示。

2.3 - 2025-12-21
- 新增：音量均衡分析面板（显示已分析/未分析，一键预分析，支持空闲自动分析）。
- 新增：可关闭“播放时后台分析”，避免播放过程中音量后跳变。
- 安全：清空缓存增加二次确认，默认“不清除”（回车不会误清）。
- 顶栏：恢复并整理“搜索/设置”菜单（去掉重复项），功能更好找。
- 导入：文件夹扫描支持进度与取消；跳过符号链接目录避免递归循环。
- 播放：播放失败/解码失败会提示并自动标记“不可播放”，自动跳过继续播放。
- 稳定性：修复通知监听与 CoreAudio 回调/指针使用的潜在问题（窗口重开/设备监听更可靠）。
- 通知：修复“设置 → 通知”菜单闪烁/开关状态不刷新；前台通知按“静音”选项不播放声音。

2.2 - 2025-12-18
- 拖拽导入：全局/拖拽区域统一使用 TaskGroup 收集 URL，避免并发写数组导致丢文件/偶发崩溃。
- 快速切歌/重载：用 loadGeneration 防止旧异步任务回写；歌词/封面/音量分析只更新当前曲目；音量缓存加锁消除数据竞争。
- 播放列表：保存与迁移统一走串行写盘，避免旧快照覆盖新快照。
- 恢复逻辑：外部临时打开文件仅本次跳过恢复（不写入 UserDefaults），避免影响下次启动。
- 性能/内存：封面按需加载，NSCache 上限（raw 300/32MB，blur 200/48MB）。
- 构建：build.sh 在沙箱失败时自动回退 `swift build --disable-sandbox`。

2.1 - 2025-12-06
- 启动：优化大播放列表恢复流程，分离列表恢复与元数据重解析，首次启动不再因为几千首歌卡死
- 列表：播放列表从 UserDefaults 迁移到 Application Support 下 `playlist.json`，更可靠也不再撑爆偏好
- 音量：音量均衡缓存迁移至 Application Support 下 `volume-cache.json`，自动迁移旧数据并支持一键清空
- 音量：每首歌只分析一次响度（去重中途分析任务），并从“前 180 秒”改为分析整首，切歌响度更均衡
- 焦点：启动时不再自动聚焦搜索框，点击播放列表任意空白处即可自动取消搜索框焦点

2.0 - 2025-12-05
- UI：新增暗色模式与统一主题配色，暗/亮背景更协调
- 交互：文本输入/输入法使用空格或回车时不再误触播放；ESC 可直接退出搜索框焦点

1.9 - 2025-11-04
- 新增：耳机断开自动暂停，恢复自动续播
- 新增：界面显示当前音频输出设备
- 新增：切换输出设备时支持系统通知（默认静音，可在“设置”中开关）
- 行为：合盖/睡眠后再次唤醒不再自动开始播放（需手动点击播放）
- 修复：播放按钮状态不同步问题

1.8 - 2025-09-29
- 修复修改歌曲名、歌手名等元数据的时候会误覆盖现有歌词和封面的bug
- 音量均衡优化：将响度分析窗口从前 60 秒扩展到前 180 秒（若曲长不足则全曲），按剩余帧精准累加，短曲与缓启曲目的评估更稳定。
- 新增"设置"菜单：可独立清空音量均衡、封面、歌词缓存
- 封面缓存上限提升至 500 张

1.7 - 2025-09-13
- 新增：元数据编辑支持“歌词”输入（LRC/纯文本），保存直写 M4A/MP4/AAC 的 ©lyr（不转码、无需 FFmpeg）；播放器自动识别时间戳并按“动态歌词”显示。
- 歌词：默认展示完整歌词；移除窗口化渲染；滚动体验优化（不再拦截外层滚动）；保留自动跟随与双击定位。
- 稳定：为音频初始化与元数据加载增加 20s 超时，超时/错误自动跳到下一首，避免卡住。
- 修复：刷新/恢复后进度丢失的问题（新增 pendingSeekTime，播放器就绪前先定位）。
- 交互：播放列表整条条目可点击播放（无需只点小图标）。
- 行为：保存元数据后仅刷新所编辑文件的歌词与当前曲目，播放不中断。
- 兼容：Apple Music 不解析时间戳，©lyr 中的 LRC 在其内显示为纯文本，属预期。

1.6 - 2025-09-10
- 新增：支持 Finder/Dock 直接临时播放单曲（不入库；关闭或再次临时打开将丢失进度）。
- 默认关联：将 mp3、m4a/aac、wav、aif/aiff/aifc、caf 设为默认打开（Owner）；flac/ogg/opus 保持候选（Alternate）。
- 偏好：新增“扫描子文件夹”开关持久化，重启后记住用户选择。
- 播放列表：导入按路径去重，保留最早已加入的条目，忽略重复文件。
- 兼容：新增 MP3 的 ID3v1 + GBK/GB18030 回退读取，修复仅含 ID3v1 的中文歌曲显示乱码；优先使用 ID3v2，必要时回退，性能影响可忽略。
- 歌词：移除“拖拽后 5s 自动恢复跟随”，仅由开关或“定位当前句”恢复；且当鼠标在歌词区域内时禁用外层滚动，避免滚动穿透。
- 歌词：同步刷新频率调整为 100ms（原 200ms）；对于超过两位小数的 LRC 时间戳仅读取前两位精度，例如 [01:53.229996] 解析为 [01:53.22]。
- 修复：首次导入显示元数据不全的问题，导入阶段统一使用异步完整加载（AVURLAsset.load(.metadata)）。
- 修复：编辑其他歌曲元数据后执行“刷新”，当前播放歌曲歌词被清空的问题（刷新时优先保留当前曲目的歌词时间轴）。
- 说明：对外部修改过元数据/歌词的文件，可通过“刷新”立即更新到列表。

1.5 - 2025-08-08
- 动态歌词：二分查找 + 索引去抖 + 200ms 节流 + 窗口渲染，滚动更顺滑
- 封面：增加 NSCache 缓存与预模糊，减少解码与滤镜开销
- 修复了随机播放偶然出现暂停的问题

1.4 - 2025-08-04
- 支持歌词显示：静态与动态歌词（.lrc）
- 文档与引导完善：新增首次运行常见问题与解决方案
- 修复：关闭窗口后再次打开出现多个音频重叠播放的问题

1.3 - 2025-08-01
- 新增智能音量均衡功能（RMS 分析，统一至标准音量）
- 增加音量分析结果缓存，避免重复分析
- 在“音频效果”面板中提供开关
- 修复内存泄漏与优化窗口/Timer 管理
- 增强错误处理机制
- 秒级播放进度保存：以秒为单位保存进度，暂停/停止时立即保存

1.2 - 2025-07-24
- 播放状态记忆：恢复上次歌曲与播放位置（断点续播）
- 播放列表记忆：自动保存并恢复
- 重新随机播放按钮（骰子）
- 智能播放恢复：启动自动从上次位置继续
- 播放进度保存：每 5 秒自动保存，暂停/停止时立即保存

1.1 - 2025-07-23
- 文件夹递归扫描
- 修复随机播放与单曲循环逻辑
- 响应式布局
- 优化文件选择与拖拽体验
- 支持修改元数据，难以修改的格式提供 ffmpeg 命令快捷复制

1.0 - 2025-07-18
- 开始做 macOS 的 app 啦！再也不用 Safari + HTML 听啦！呜呼~
- 初始版本
- 基础播放功能
- 拖拽添加
- 播放列表与搜索
- 单曲循环与随机播放
- 编辑元数据
 
## 作者

- lueluelue
